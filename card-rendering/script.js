/* ======================== Mana Symbols Mapping ======================== */
const mana_symbols = {
  "{0}": { svg_uri: "assets/img/symbols/0.svg" },
  "{1}": { svg_uri: "assets/img/symbols/1.svg" },
  "{2}": { svg_uri: "assets/img/symbols/2.svg" },
  "{2B}": { svg_uri: "assets/img/symbols/2B.svg" },
  "{2G}": { svg_uri: "assets/img/symbols/2G.svg" },
  "{2R}": { svg_uri: "assets/img/symbols/2R.svg" },
  "{2U}": { svg_uri: "assets/img/symbols/2U.svg" },
  "{2W}": { svg_uri: "assets/img/symbols/2W.svg" },
  "{3}": { svg_uri: "assets/img/symbols/3.svg" },
  "{4}": { svg_uri: "assets/img/symbols/4.svg" },
  "{5}": { svg_uri: "assets/img/symbols/5.svg" },
  "{6}": { svg_uri: "assets/img/symbols/6.svg" },
  "{7}": { svg_uri: "assets/img/symbols/7.svg" },
  "{8}": { svg_uri: "assets/img/symbols/8.svg" },
  "{9}": { svg_uri: "assets/img/symbols/9.svg" },
  "{10}": { svg_uri: "assets/img/symbols/10.svg" },
  "{11}": { svg_uri: "assets/img/symbols/11.svg" },
  "{12}": { svg_uri: "assets/img/symbols/12.svg" },
  "{13}": { svg_uri: "assets/img/symbols/13.svg" },
  "{14}": { svg_uri: "assets/img/symbols/14.svg" },
  "{15}": { svg_uri: "assets/img/symbols/15.svg" },
  "{16}": { svg_uri: "assets/img/symbols/16.svg" },
  "{17}": { svg_uri: "assets/img/symbols/17.svg" },
  "{18}": { svg_uri: "assets/img/symbols/18.svg" },
  "{19}": { svg_uri: "assets/img/symbols/19.svg" },
  "{20}": { svg_uri: "assets/img/symbols/20.svg" },
  "{100}": { svg_uri: "assets/img/symbols/100.svg" },
  "{1000000}": { svg_uri: "assets/img/symbols/1000000.svg" },
  "{A}": { svg_uri: "assets/img/symbols/A.svg" },
  "{B}": { svg_uri: "assets/img/symbols/B.svg" },
  "{BG}": { svg_uri: "assets/img/symbols/BG.svg" },
  "{BGP}": { svg_uri: "assets/img/symbols/BGP.svg" },
  "{BR}": { svg_uri: "assets/img/symbols/BR.svg" },
  "{BRP}": { svg_uri: "assets/img/symbols/BRP.svg" },
  "{C}": { svg_uri: "assets/img/symbols/C.svg" },
  "{CB}": { svg_uri: "assets/img/symbols/CB.svg" },
  "{CG}": { svg_uri: "assets/img/symbols/CG.svg" },
  "{CHAOS}": { svg_uri: "assets/img/symbols/CHAOS.svg" },
  "{CP}": { svg_uri: "assets/img/symbols/CP.svg" },
  "{CR}": { svg_uri: "assets/img/symbols/CR.svg" },
  "{CU}": { svg_uri: "assets/img/symbols/CU.svg" },
  "{CW}": { svg_uri: "assets/img/symbols/CW.svg" },
  "{D}": { svg_uri: "assets/img/symbols/D.svg" },
  "{E}": { svg_uri: "assets/img/symbols/E.svg" },
  "{G}": { svg_uri: "assets/img/symbols/G.svg" },
  "{GU}": { svg_uri: "assets/img/symbols/GU.svg" },
  "{GUP}": { svg_uri: "assets/img/symbols/GUP.svg" },
  "{GW}": { svg_uri: "assets/img/symbols/GW.svg" },
  "{GWP}": { svg_uri: "assets/img/symbols/GWP.svg" },
  "{H}": { svg_uri: "assets/img/symbols/H.svg" },
  "{HALF}": { svg_uri: "assets/img/symbols/HALF.svg" },
  "{HR}": { svg_uri: "assets/img/symbols/HR.svg" },
  "{HW}": { svg_uri: "assets/img/symbols/HW.svg" },
  "{INFINITY}": { svg_uri: "assets/img/symbols/INFINITY.svg" },
  "{L}": { svg_uri: "assets/img/symbols/L.svg" },
  "{P}": { svg_uri: "assets/img/symbols/P.svg" },
  "{PW}": { svg_uri: "assets/img/symbols/PW.svg" },
  "{Q}": { svg_uri: "assets/img/symbols/Q.svg" },
  "{R}": { svg_uri: "assets/img/symbols/R.svg" },
  "{RG}": { svg_uri: "assets/img/symbols/RG.svg" },
  "{RGP}": { svg_uri: "assets/img/symbols/RGP.svg" },
  "{RP}": { svg_uri: "assets/img/symbols/RP.svg" },
  "{RW}": { svg_uri: "assets/img/symbols/RW.svg" },
  "{RWP}": { svg_uri: "assets/img/symbols/RWP.svg" },
  "{S}": { svg_uri: "assets/img/symbols/S.svg" },
  "{T}": { svg_uri: "assets/img/symbols/T.svg" },
  "{TK}": { svg_uri: "assets/img/symbols/TK.svg" },
  "{U}": { svg_uri: "assets/img/symbols/U.svg" },
  "{UB}": { svg_uri: "assets/img/symbols/UB.svg" },
  "{UBP}": { svg_uri: "assets/img/symbols/UBP.svg" },
  "{UP}": { svg_uri: "assets/img/symbols/UP.svg" },
  "{UR}": { svg_uri: "assets/img/symbols/UR.svg" },
  "{URP}": { svg_uri: "assets/img/symbols/URP.svg" },
  "{W}": { svg_uri: "assets/img/symbols/W.svg" },
  "{WB}": { svg_uri: "assets/img/symbols/WB.svg" },
  "{WBP}": { svg_uri: "assets/img/symbols/WBP.svg" },
  "{WP}": { svg_uri: "assets/img/symbols/WP.svg" },
  "{WU}": { svg_uri: "assets/img/symbols/WU.svg" },
  "{WUP}": { svg_uri: "assets/img/symbols/WUP.svg" },
  "{X}": { svg_uri: "assets/img/symbols/X.svg" },
  "{Y}": { svg_uri: "assets/img/symbols/Y.svg" },
  "{Z}": { svg_uri: "assets/img/symbols/Z.svg" }
};

// Sets with icons (for set icons, etc.)
const sets_with_icons = [
  "med", "m3c", "mb2", "9ed", "cmd", "m11", "vma", "8ed", "mkc", "ddp", "m12",
  "ons", "c18", "eld", "zen", "rvr", "evg", "bro", "bbd", "anb", "mm2", "ha4",
  "uma", "dds", "dom", "m13", "scg", "otj", "dst", "dsc", "und", "c15", "ddm",
  "gnt", "big", "mkm", "c19", "m19", "mat", "v14", "tpr", "con", "c17", "exp",
  "m14", "woe", "mid", "w17", "wwk", "ema", "avr", "iko", "mh1", "afr", "thb",
  "blc", "tsb", "ddd", "v13", "m21", "ha5", "dsk", "ncc", "ktk", "c16", "khm",
  "nph", "som", "ddt", "jou", "mb1", "mm3", "mom", "pip", "5dn", "fdc", "fut",
  "moc", "afc", "ddu", "ltc", "stx", "ths", "mma", "spg", "j22", "ddn", "unh",
  "xln", "wot", "grn", "lgn", "rix", "dmu", "m15", "clu", "cns", "cc1", "h09",
  "v09", "v12", "cn2", "ddo", "e02", "v17", "sis", "pd2", "bng", "bot", "otc",
  "gn3", "cma", "vow", "me2", "lcc", "40k", "dis", "m10", "sta", "2xm", "ha3",
  "chk", "me3", "mic", "soi", "dka", "v15", "gn2", "war", "j21", "voc", "ddj",
  "jud", "znr", "ust", "acr", "c13", "ltr", "ddi", "g18", "plc", "rex", "rtr",
  "w16", "ddc", "ala", "hou", "ori", "fdn", "10e", "c21", "j25", "dd2", "roe",
  "sir", "ha2", "aer", "cm2", "snc", "ss2", "znc", "ddl", "gpt", "jmp", "v16",
  "m20", "drb", "v11", "md1", "cmm", "lrw", "bok", "mor", "tsp", "mh2", "ima",
  "nec", "eve", "dgm", "dde", "dmc", "tor", "brr", "2x2", "neo", "ha1", "rna",
  "zne", "cmr", "ss1", "bfz", "dtk", "sch", "gtc", "c14", "mh3", "ddg", "mrd",
  "csp", "a25", "frf", "c20", "ddk", "kld", "akr", "blb", "lci", "v10", "isd",
  "akh", "sld", "sok", "cm1", "khc", "mul", "who", "ddq", "tsr", "woc", "clb",
  "dmr", "me4", "klr", "pd3", "one", "onc", "ddf", "hop", "otp", "emn", "gs1",
  "gdy", "ddh", "arb", "arc", "shm", "e01", "ddr", "pc2", "pca", "brc", "hbg",
  "ogw", "rav", "mbs"
];

/* ======================== Utility: parseOracle ======================== */
/* Replaces mana symbols with <img> tags and wraps text in parentheses in a span */
function parseOracle(str) {
  const manaRegex = /{([^}]+)}/g;
  str = str.replace(manaRegex, (match, group) => {
    const key = `{${group}}`;
    if (mana_symbols[key]) {
      return `<img src="${mana_symbols[key].svg_uri}" class="ms">`;
    }
    return match;
  });
  str = str.replace(/\([^)]+\)/g, (match) => `<span class="oracle-reminder">${match}</span>`);
  return str;
}

/* ======================== computeCardProps ======================== */
/* Computes properties from the card data. */
function computeCardProps(card, currentFace) {
  let props = {};

  // card_face and back_face
  props.card_face =
    card.card_faces && card.card_faces.length
      ? card.card_faces[card.layout === "adventure" ? 0 : currentFace || 0]
      : card;
  props.back_face =
    card.card_faces && card.card_faces.length
      ? card.card_faces[(currentFace + 1) % 2]
      : card;

  // Determine types
  props.is_land =
    props.card_face.type_line &&
    (props.card_face.type_line.startsWith("Land") ||
      props.card_face.type_line.startsWith("Terrain"));
  props.is_legendary =
    (card.frame_effects && card.frame_effects.includes("legendary")) ||
    (props.card_face.type_line &&
      (props.card_face.type_line.startsWith("Legendary") ||
       props.card_face.type_line.includes("légendaire")));
  props.is_planeswalker =
    props.card_face.type_line &&
    props.card_face.type_line.toLowerCase().includes("planeswalker");
  props.has_legendary_crown =
    props.is_legendary &&
    !props.is_planeswalker &&
    !(card.frame_effects && card.frame_effects.includes("compasslanddfc"));

  // Layout types
  props.is_adventure = card.layout === "adventure";
  props.is_saga =
    props.card_face.layout === "saga" ||
    (props.card_face.type_line && props.card_face.type_line.includes("Saga"));
  props.is_class =
    props.card_face.layout === "class" ||
    (props.card_face.type_line && props.card_face.type_line.includes("Class"));
  props.is_vehicle =
    props.card_face.type_line &&
    (props.card_face.type_line.includes("Vehicle") ||
      props.card_face.type_line.includes("Véhicule"));
  props.is_dualfaced = card.card_faces && !props.is_adventure;
  props.is_mdfc = card.layout === "modal_dfc";
  props.is_transform = card.layout === "transform";
  props.is_levelup =
    props.card_face.oracle_text &&
    (props.card_face.oracle_text.includes("Level up") ||
     props.card_face.oracle_text.includes("Montée de niveau"));

  // Parse mana cost
  const manaRegex = /{([^}]+)}/g;
  props.mana_cost = [];
  if (props.card_face.mana_cost) {
    let match;
    while ((match = manaRegex.exec(props.card_face.mana_cost)) !== null) {
      props.mana_cost.push(
        mana_symbols[`{${match[1]}}`] ? mana_symbols[`{${match[1]}}`].svg_uri : ""
      );
    }
  }

  // Adventure/modal back mana cost
  props.adventure_mana_cost = [];
  if (card.card_faces && card.card_faces[1] && card.card_faces[1].mana_cost) {
    manaRegex.lastIndex = 0;
    let match;
    while ((match = manaRegex.exec(card.card_faces[1].mana_cost)) !== null) {
      props.adventure_mana_cost.push(
        mana_symbols[`{${match[1]}}`] ? mana_symbols[`{${match[1]}}`].svg_uri : ""
      );
    }
  }
  props.mdfc_back_mana_cost = [];
  if (
    card.card_faces &&
    card.card_faces[(currentFace + 1) % 2] &&
    card.card_faces[(currentFace + 1) % 2].mana_cost
  ) {
    manaRegex.lastIndex = 0;
    let match;
    while ((match = manaRegex.exec(card.card_faces[(currentFace + 1) % 2].mana_cost)) !== null) {
      props.mdfc_back_mana_cost.push(
        mana_symbols[`{${match[1]}}`] ? mana_symbols[`{${match[1]}}`].svg_uri : ""
      );
    }
  }

  // MDFC hint text
  if (props.card_face.mdfc_hint)
    props.mdfc_hint_text = props.card_face.mdfc_hint;
  else if (props.back_face.type_line)
    props.mdfc_hint_text = props.back_face.type_line.substr(props.back_face.type_line.indexOf("—") + 1).trim();
  else
    props.mdfc_hint_text = "";

  // Extended art?
  props.extended_art = ["extended", "full", "full-footer"].includes(props.card_face.art_variant);

  // Oracle text and flavor text
  props.oracle_lines = props.card_face.oracle_text
    ? props.card_face.oracle_text.split("\n").map(parseOracle)
    : [];
  props.adventure_oracle_lines =
    card.card_faces && card.card_faces[1] && card.card_faces[1].oracle_text
      ? card.card_faces[1].oracle_text.split("\n").map(parseOracle)
      : [];
  props.saga_reminder = props.card_face.oracle_text
    ? parseOracle(props.card_face.oracle_text.split("\n")[0])
    : "";
  props.class_reminder = props.saga_reminder;
  if (props.card_face.oracle_text) {
    let steps = props.card_face.oracle_text.split("\n").filter(s => s.match(/^(.+) — /));
    props.saga_steps = steps.map(s => {
      let m = s.match(/(.+) — (.+)/);
      let icons = m[1].split(",").map(s => "assets/img/saga/" + s.trim() + ".webp");
      return { steps: icons, html: parseOracle(m[2]) };
    });
  } else {
    props.saga_steps = [];
  }
  props.class_steps = props.card_face.oracle_text
    ? props.card_face.oracle_text.split("\n").slice(1).map(line => ({
        class: "normal",
        html: parseOracle(line)
      }))
    : [];

  // For planeswalkers, parse abilities (each line with a cost)
  if (props.is_planeswalker && props.card_face.oracle_text) {
    props.planeswalker_abilities = props.card_face.oracle_text.split("\n").map(line => {
      let ability = { html: parseOracle(line), cost: null };
      let m = line.match(/^[+-−]?(\d+):/);
      if (m) {
        if (line[0] === "0") ability.cost = 0;
        else if (line[0] === "+") ability.cost = parseInt(m[1]);
        else ability.cost = -parseInt(m[1]);
        ability.html = parseOracle(line.substr(m[0].length + 1));
      }
      return ability;
    });
  } else {
    props.planeswalker_abilities = null;
  }

  // (Levels – omitted for brevity; you can add if needed)

  // Copyright
  props.copyright =
    card.copyright || `™ & © ${new Date().getFullYear()} Wizards of the Coast`;

  // Colors (compute from face.colors, color_identity, or mana_cost)
  function contains(str, search) {
    if (!str || !search) return false;
    if (Array.isArray(search))
      return search.some(s => str.toLowerCase().includes(s.toLowerCase()));
    return str.toLowerCase().includes(search.toLowerCase());
  }
  function computeColors(face) {
    let colors;
    if (face.colors && face.colors.length > 0) colors = face.colors;
    else if (face.color_identity) colors = face.color_identity;
    else if (face.mana_cost) colors = Array.from(face.mana_cost).filter(c => "WUBRG".includes(c));
    else colors = [];
    if (colors.length === 0 && card.color_identity && card.color_identity.length > 0)
      colors = card.color_identity;
    let sorted_colors = [...new Set(colors)]
      .sort((l, r) => "WUBRG".indexOf(l) - "WUBRG".indexOf(r))
      .join("");
    return contains(face.type_line, ["Artifact", "Artefact", "Artéfact"])
      ? "Artifact"
      : sorted_colors.length === 0
        ? "Colourless"
        : sorted_colors.length > 2
          ? "Gold"
          : sorted_colors;
  }
  props.colors = computeColors(props.card_face);

  // Boxes colors (simplified)
  if (props.is_vehicle) props.boxes_colors = "Vehicle";
  else if (props.is_land)
    props.boxes_colors = props.colors.length > 2 && props.colors.length < 5 ? "Gold" : "Land";
  else
    props.boxes_colors = props.colors.length > 1 && props.colors.length < 5 ? "Gold" : props.colors;

  // Background – choose folder based on card type
  let folder;
  if (props.is_planeswalker)
    folder = props.is_large_planeswalker ? "planeswalker_large_bg" : "planeswalker_bg";
  else if (props.is_saga) folder = "saga_bg";
  else if (props.is_class) folder = "saga_bg";
  else if (card.frame_effects && card.frame_effects.includes("compasslanddfc") && currentFace === 1)
    folder = "ixalan_bg";
  else folder = "bg";
  props.background = `url(assets/img/${folder}/${props.is_vehicle ? "Vehicle" : props.boxes_colors}.webp)`;

  // Frame – choose folder based on layout
  if (props.is_adventure) folder = "adventure_frames";
  else if (props.is_saga) folder = "saga_frames";
  else if (props.is_class) folder = "class_frames";
  else if (props.is_planeswalker) folder = props.is_large_planeswalker ? "planeswalker_large_frames" : "planeswalker_frames";
  else if (props.is_mdfc) folder = "mdfc_frames";
  else if (props.is_transform) folder = currentFace === 0 ? "transform_frames" : "transform_back_frames";
  else folder = "frames";
  if (props.extended_art && !props.is_saga && !props.is_class) folder = "extended_" + folder;
  let frameColor = (props.colors === "Artifact" && props.card_face.colors && props.card_face.colors.length === 1)
      ? props.card_face.colors[0]
      : props.colors;
  props.frame = `url(assets/img/${folder}/${frameColor}.webp)`;

  // Boxes and mid_boxes
  folder = props.is_planeswalker
    ? "planeswalker_boxes"
    : props.is_mdfc || props.is_transform
      ? currentFace === 0 ? "mdfc_boxes" : "mdfc_back_boxes"
      : props.extended_art && !props.is_class
        ? "extended_boxes"
        : "boxes";
  props.boxes = `url(assets/img/${folder}/${props.boxes_colors}.webp)`;
  props.mid_boxes = props.extended_art && !props.is_planeswalker && !props.is_class
    ? `url(assets/img/extended_boxes/${props.boxes_colors}.webp)`
    : props.boxes;

  // Legendary crown
  let crownFolder = props.extended_art ? "extended_legendary_crowns" : "legendary_crowns";
  props.legendary_crown = `url(assets/img/${crownFolder}/${props.boxes_colors}.webp)`;

  // pt_box (only used for non-planeswalkers)
  let ptFolder = (props.is_mdfc || props.is_transform) && currentFace === 1 ? "transform_back_pt_boxes" : "pt_boxes";
  props.pt_box = `url(assets/img/${ptFolder}/${props.is_vehicle ? "Vehicle" : props.boxes_colors}.webp)`;

  // Saga text box
  props.saga_text_box = `url(assets/img/saga_textboxes/${props.boxes_colors}.webp)`;

  // MDFC icon and hint
  props.mdfc_icon = `url(assets/img/mdfc${currentFace === 0 ? "" : "_back"}_icons/${props.boxes_colors === "Land" ? props.colors : props.boxes_colors}.webp)`;
  let hintColors = props.colors;
  if (hintColors.length > 1 && hintColors.length < 5) hintColors = "Gold";
  props.mdfc_hint = `url(assets/img/mdfc${currentFace === 0 ? "" : "_back"}_hints/${hintColors}.webp)`;
  props.mdfc_hint_color = currentFace === 0 ? "white" : "black";

  // Transform icon
  props.transform_icon = `url(assets/img/transform${currentFace === 0 ? "" : "_back"}_icons/${card.frame_effects && card.frame_effects[0] ? card.frame_effects[0] : "sunmoondfc"}.webp)`;

  // pt_box color and line colors
  props.pt_box_color = props.is_vehicle || (props.is_transform && currentFace === 1) ? "white" : "black";
  if (props.is_mdfc)
    props.top_line_color = currentFace === 0 ? "black" : "white";
  else if (props.is_transform && currentFace === 1 && !props.is_planeswalker)
    props.top_line_color = "white";
  else
    props.top_line_color = "black";
  if ((props.extended_art && !props.is_class && !props.is_planeswalker && (!props.is_transform || currentFace === 0)) ||
      ((props.is_transform || props.is_mdfc) && currentFace === 1 && !props.is_planeswalker))
    props.mid_line_color = "white";
  else
    props.mid_line_color = "black";

  // Color indicator
  if (props.card_face.color_indicator) {
    let sorted = Array.from(props.card_face.color_indicator)
      .sort((a, b) => "WUBRG".indexOf(a) - "WUBRG".indexOf(b))
      .join("");
    props.color_indicator = `assets/img/color_indicators/${sorted}.webp`;
  } else {
    props.color_indicator = "";
  }

  // Illustration – choose from image_uris.art_crop if available
  let artCard = props.is_adventure ? card : props.card_face;
  let artUrl = "";
  if (artCard.image_uris && artCard.image_uris.art_crop && artCard.image_uris.art_crop.trim() !== "") {
    artUrl = artCard.image_uris.art_crop;
  } else {
    artUrl = "assets/img/placeholder-art.webp";
  }
  props.illustration = `url("${artUrl}")`;
  props.illustration_scale = artCard.illustration_scale || 1;
  if (artCard.illustration_position) {
    props.illustration_position = {
      x: artCard.illustration_position.x + "mm",
      y: artCard.illustration_position.y + "mm"
    };
  } else {
    props.illustration_position = { x: "0mm", y: "0mm" };
  }

  // Set icon URI
  if (card.set_icon)
    props.set_icon_uri = card.set_icon;
  else if (sets_with_icons.includes(card.set))
    props.set_icon_uri = `assets/img/set_icons/${card.set}_${card.rarity || "common"}.webp`;
  else
    props.set_icon_uri = "";

  // Archive frame colors (simplified)
  let archiveColor = (props.card_face.color_identity && props.card_face.color_identity[0]) ? props.card_face.color_identity[0] : "Gold";
  props.archive_frame_colors = {
    primary: archiveColor,
    lighter: archiveColor,
    darker: archiveColor,
    left: { primary: archiveColor, lighter: archiveColor, darker: archiveColor },
    right: { primary: archiveColor, lighter: archiveColor, darker: archiveColor }
  };

  // (Japanese colors, borders, etc. – omitted here for brevity; include if needed)

  return props;
}

/* ======================== Helper: resizeTextHorizontally ======================== */
const resizeTextHorizontally = (el) => {
  const computedStyle = window.getComputedStyle(el);
  let fontSize = parseFloat(computedStyle.fontSize);
  el.style.fontSize = fontSize + "px";
  while (el.scrollWidth > el.clientWidth && fontSize > 4) {
    fontSize -= 0.5;
    el.style.fontSize = fontSize + "px";
  }
};

/* ======================== createMTGCard ======================== */
function createMTGCard(card, scale = 1, renderMargin = 1) {
  const currentFace = 0;
  const props = computeCardProps(card, currentFace);
  const cardEl = document.createElement("div");
  cardEl.className = "mtg-card";

  // For planeswalkers, add the appropriate classes.
  if (props.is_planeswalker) {
    cardEl.classList.add("planeswalker");
    // Only add 'planeswalker-large' if there are more than 3 abilities.
    if (props.planeswalker_abilities && props.planeswalker_abilities.length > 3) {
      cardEl.classList.add("planeswalker-large");
    }
  }
  if (props.is_legendary) {
    cardEl.classList.add("legendary");
  }

  // Set CSS custom properties
  cardEl.style.setProperty("--bg-image", props.background);
  cardEl.style.setProperty("--frame-image", props.frame);
  cardEl.style.setProperty("--boxes-image", props.boxes);
  cardEl.style.setProperty("--mid-boxes-image", props.mid_boxes);
  cardEl.style.setProperty("--top-line-color", props.top_line_color);
  cardEl.style.setProperty("--mid-line-color", props.mid_line_color);
  cardEl.style.setProperty("--pt-box-image", props.pt_box);
  cardEl.style.setProperty("--pt-box-color", props.pt_box_color);
  cardEl.style.setProperty("--saga-text-box-image", props.saga_text_box);
  cardEl.style.setProperty("--mdfc-icon-image", props.mdfc_icon);
  cardEl.style.setProperty("--mdfc-hint-image", props.mdfc_hint);
  cardEl.style.setProperty("--mdfc-hint-color", props.mdfc_hint_color);
  cardEl.style.setProperty("--transform-icon-image", props.transform_icon);
  cardEl.style.setProperty("--renderMargin", renderMargin);
  cardEl.style.setProperty("--scale", scale);
  cardEl.style.setProperty("--frame-colors-left", props.archive_frame_colors.left.primary);
  cardEl.style.setProperty("--frame-colors-right", props.archive_frame_colors.right.primary);
  cardEl.style.setProperty("--illustration-image", props.illustration);
  cardEl.style.setProperty("--illustration-position-x", props.illustration_position.x);
  cardEl.style.setProperty("--illustration-position-y", props.illustration_position.y);
  cardEl.style.setProperty("--illustration-scale", props.illustration_scale);

  // Build inner HTML based on card type
  if (props.is_planeswalker) {
    cardEl.innerHTML = `
      <div class="inner-background"></div>
      <div class="illustration behind-textbox"></div>
      <div class="planeswalker-oracle-bg"></div>
      <div class="inner-frame"></div>
      <div class="legendary-crown" style="display: none;"></div>
      <div class="top-line">
        <span class="name">${props.card_face.printed_name || props.card_face.name}</span>
        <div class="mana-cost">
          ${props.mana_cost.map(uri => `<img src="${uri}" class="ms">`).join("")}
        </div>
      </div>
      <div class="mid-line">
        ${props.card_face.color_indicator ? `<img class="color-indicator" src="${props.color_indicator}">` : ""}
        <div class="type-line">${props.card_face.type_line}</div>
        ${props.set_icon_uri ? `<div class="set-icon-container"><img class="set-icon" src="${props.set_icon_uri}"></div>` : ""}
      </div>
      <div class="oracle planeswalker-oracle" style="font-size: 6.48pt;">
        ${props.planeswalker_abilities ? props.planeswalker_abilities.map(ability => {
          if (ability.cost !== null) {
            return `<div class="planeswalker-ability planeswalker-ability-with-cost">
                      <div class="planeswalker-ability-cost ${ability.cost > 0 ? "planeswalker-ability-cost-plus" : "planeswalker-ability-cost-minus"}">
                        ${ability.cost > 0 ? "+" + ability.cost : ability.cost}
                      </div>
                      <div class="planeswalker-ability-text">${ability.html}</div>
                    </div>`;
          } else {
            return `<div class="planeswalker-ability">
                      <div class="planeswalker-ability-text">${ability.html}</div>
                    </div>`;
          }
        }).join("") : ""}
      </div>
      <div class="footer">
        <div class="footer-left">
          <div class="collector-number">${(props.is_adventure || !props.card_face.collector_number)
              ? card.collector_number
              : props.card_face.collector_number}</div>
          <div>
            ${card.set ? `<span class="set">${card.set.toUpperCase()}</span>` : ""}
            ${card.set && card.lang ? "&nbsp;•&nbsp;" : ""}
            ${card.lang ? `<span class="language">${card.lang.toUpperCase()}</span>` : ""}
            ${card.artist ? '<span class="artist-icon"> a </span>' : ""}
            ${card.artist ? `<span class="artist-name">${card.artist}</span>` : ""}
          </div>
        </div>
        <div class="footer-right">
          <div>&nbsp;</div>
          <div class="copyright">${card.copyright || `™ & © ${new Date().getFullYear()} Wizards of the Coast`}</div>
        </div>
      </div>
    `;
  } else {
    // Default (non-planeswalker) rendering.
    cardEl.innerHTML = `
      <div class="inner-background"></div>
      <div class="inner-frame"></div>
      <div class="top-line">
        <span class="name">${props.card_face.printed_name || props.card_face.name}</span>
        <div class="mana-cost">
          ${props.mana_cost.map(uri => `<img src="${uri}" class="ms">`).join("")}
        </div>
      </div>
      <div class="mid-line">
        ${props.card_face.color_indicator ? `<img class="color-indicator" src="${props.color_indicator}">` : ""}
        <div class="type-line">${props.card_face.type_line}</div>
        ${props.set_icon_uri ? `<div class="set-icon-container"><img class="set-icon" src="${props.set_icon_uri}"></div>` : ""}
      </div>
      <div class="illustration"></div>
      <div class="oracle normal-oracle">
        ${props.oracle_lines.map(line => `<div class="oracle-inner">${line}</div>`).join("")}
        ${props.card_face.flavor_text ? `<div class="oracle-flavor"><hr>${props.card_face.flavor_text}</div>` : ""}
      </div>
      ${props.card_face.power !== undefined && props.card_face.toughness !== undefined
        ? `<div class="pt-box">
             <span>${props.card_face.power}</span>/<span>${props.card_face.toughness}</span>
           </div>`
        : ""}
      <div class="footer">
        <div class="footer-left">
          <div class="collector-number">${(props.is_adventure || !props.card_face.collector_number)
              ? card.collector_number
              : props.card_face.collector_number}</div>
          <div>
            ${card.set ? `<span class="set">${card.set.toUpperCase()}</span>` : ""}
            ${card.set && card.lang ? "&nbsp;•&nbsp;" : ""}
            ${card.lang ? `<span class="language">${card.lang.toUpperCase()}</span>` : ""}
            ${card.artist ? '<span class="artist-icon"> a </span>' : ""}
            ${card.artist ? `<span class="artist-name">${card.artist}</span>` : ""}
          </div>
        </div>
        <div class="footer-right">
          <div>&nbsp;</div>
          <div class="copyright">${card.copyright || `™ & © ${new Date().getFullYear()} Wizards of the Coast`}</div>
        </div>
      </div>
    `;
  }

  // Set illustration background
  const illustrationDiv = cardEl.querySelector(".illustration, .illustration.behind-textbox");
  if (illustrationDiv) {
    illustrationDiv.style.backgroundImage = props.illustration;
    illustrationDiv.style.backgroundSize = `calc(${props.illustration_scale} * 100%)`;
    illustrationDiv.style.backgroundPosition = `${props.illustration_position.x} ${props.illustration_position.y}`;
    illustrationDiv.style.backgroundRepeat = "no-repeat";
  }

  // Horizontal text resizing for name and type line
  const nameEl = cardEl.querySelector('.name');
  if (nameEl) {
    resizeTextHorizontally(nameEl);
    const nameObserver = new MutationObserver(() => resizeTextHorizontally(nameEl));
    nameObserver.observe(nameEl, { childList: true, subtree: true, characterData: true });
  }
  const typeLineEl = cardEl.querySelector('.type-line');
  if (typeLineEl) {
    resizeTextHorizontally(typeLineEl);
    const typeLineObserver = new MutationObserver(() => resizeTextHorizontally(typeLineEl));
    typeLineObserver.observe(typeLineEl, { childList: true, subtree: true, characterData: true });
  }

  // (For non-planeswalkers, vertical resizing of oracle text can be done here)
  if (!props.is_planeswalker) {
    const oracle = cardEl.querySelector('.oracle');
    if (oracle) {
      let fontSize = 1; // initial em
      oracle.style.fontSize = `${fontSize}em`;
      const resizeOracleText = () => {
        oracle.style.fontSize = `${fontSize}em`;
        while (oracle.scrollHeight > oracle.clientHeight && fontSize > 0.5) {
          fontSize -= 0.05;
          oracle.style.fontSize = `${fontSize}em`;
        }
      };
      resizeOracleText();
      const oracleObserver = new MutationObserver(resizeOracleText);
      oracleObserver.observe(oracle, { childList: true, subtree: true, characterData: true });
      const oracleResizeObserver = new ResizeObserver(resizeOracleText);
      oracleResizeObserver.observe(cardEl);
    }
  }

  return cardEl;
}

/* ------------------------ Event Listener ------------------------ */
document.getElementById("render-button").addEventListener("click", function () {
  const jsonText = document.getElementById("card-json").value;
  let card;
  try {
    card = JSON.parse(jsonText);
  } catch (e) {
    alert("Invalid JSON: " + e.message);
    return;
  }
  const container = document.getElementById("card-container");
  container.innerHTML = "";
  container.appendChild(createMTGCard(card, 1, 1));
});
